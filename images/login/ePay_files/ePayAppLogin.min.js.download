(function () {
angular.module("epayApp",["ngStorage","restangular","ngCookies","ui.router"]).constant("APIS",{EPAY_USER_LOGIN:"/epay/login",EPAY_USER_DETAILS:"/epay/user",VALIDATE_EPAY_TOKEN:"/epay/token"}).run(["$rootScope","$localStorage","$location","$cookies","$window",function(t,e,n,o,r){if(angular.isDefined(o.get("requestStr")))try{t.product=JSON.parse(o.get("requestStr")),angular.isDefined(t.product)&&(e.failureUrl=t.product.fu)}catch(e){console.log(e),t.product=o.get("requestStr")}t.$on("$stateChangeStart",function(e,t,n){console.log(n),console.log(t),o.get("requestStr")||o.get("errormsg")||(r.location.href="https://essewa.com.np")})}]).config(["$httpProvider","$sceDelegateProvider",function(e,t){t.resourceUrlWhitelist(["self","https://cdn.esewa.com.np/ui/html/**","https://cdn.esewa.com.np/ui/html/*/**"]),e.interceptors.push(["$rootScope","$q",function(e,t){return{request:function(e){return e.headers.Accept="*",e},responseError:function(e){return t.reject(e)}}}])}]),angular.module("epayApp").filter("cdn",[function(){return function(e){return"https://cdn.esewa.com.np/ui"+e}}]),angular.module("epayApp").config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/"),e.state("/",{url:"/",templateUrl:"/templates/epayLandingPage.html",controller:"UserDetailsController"}).state("epayqrConfirm",{url:"/epayqr_confirm",templateUrl:"/templates/epayqr_confirm.html",controller:"EpayQrPaymentController"}).state("epayqrCancel",{url:"/epayqr_cancel",templateUrl:"/templates/epayqr_cancel.html",controller:"EpayLoginController"})}]),angular.module("epayApp").service("LoginService",["$http","APIS",function(t,n){this.login=function(e){return t.post(n.EPAY_USER_LOGIN,e)}}]),angular.module("epayApp").service("UserDetailsService",["$http","APIS","$localStorage","$rootScope","Restangular",function(e,n,t,o,r){this.getUserDetails=function(){return e.get(n.EPAY_USER_DETAILS+"/"+o.product.moduleId+"?eSewaId="+o.product.username+"&scd="+o.product.scd+"&pid="+o.product.pid+"&amt="+o.product.tAmt)},this.validateToken=function(e,t){return r.all(n.VALIDATE_EPAY_TOKEN).one(e+"/validate").customPOST(t)}}]),angular.module("epayApp").controller("TxnDetailsController",["$scope","$localStorage","ProductDetailsService",function(e,t,n){angular.element(document.querySelector("#amt")).text(),angular.element(document.querySelector("#txAmt")).text(),angular.element(document.querySelector("#psc")).text(),angular.element(document.querySelector("#pdc")).text(),angular.element(document.querySelector("#tAmt")).text(),angular.element(document.querySelector("#scd")).text(),angular.element(document.querySelector("#pid")).text(),angular.element(document.querySelector("#su")).text(),angular.element(document.querySelector("#fu")).text()}]),angular.module("epayApp").controller("EpayLoginController",["$scope","LoginService","UserDetailsService","$rootScope","$cookies","$localStorage","$window","LogoutService",function(t,e,n,o,r,a,i,s){var c,l;for(l in t.showloadingBar=!1,angular.isDefined(r.get("authesewa"))&&(c=r.get("authesewa").split(":"),s.removeUserSession({uuid:c[1],esewa_id:o.product.username})),t.product.displayName="",r.remove("authesewa",{path:"/",domain:"localhost"}),r.remove("JSESSIONID",{path:"/",domain:"localhost"}),o.product)"fullName"!==l&&"balance"!==l&&"username"!==l||delete o.product[l];t.loginCancel=function(){t.showLoadingBar=!0;var e=o.product.fu;delete o.product,r.remove("requestStr",{path:"/",domain:"localhost"}),r.remove("authesewa",{path:"/",domain:"localhost"}),r.remove("JSESSIONID",{path:"/",domain:"localhost"}),r.remove("errormsg",{path:"/epay",domain:"localhost"}),i.location.href=e}}]),angular.module("epayApp").controller("UserDetailsController",["$scope","$rootScope","$location","$localStorage","$http","PaymentService","$window","LogoutService","UserDetailsService","$cookies","$state",function(n,o,e,r,t,a,i,s,c,l,u){n.tokenValidationError="",n.loadingBar=!1,"confirmation"!==u.current.name&&u.go("userDetails"),n.confirm=function(){u.go("confirmation")},n.confirmEpayToken=function(){var e=o.product.token;c.validateToken(e,o.product).then(function(){o.product=JSON.parse(l.get("requestStr")),o.product.loggedInWithMpin=!1,o.product.token=e},function(e){var t="Invalid Request !";angular.isDefined(e.data.error_message)&&(t=e.data.error_message),n.tokenValidationError=t;t=window.location.origin+"/failure?error="+t;window.location.replace(t)})},o.product.loggedInWithMpin&&(n.loggedInWithMpin=!0),n.cancelTransaction=function(){var e,t;n.showLoadingBar=!0,e=!angular.isDefined(o.product)&&angular.isDefined(r.failureUrl)?r.failureUrl:o.product.fu;try{d()}catch(e){console.log(e)}for(t in l.getAll())l.remove(t),l.remove(t,{path:"/epay"}),l.remove(t,{path:"/",domain:"localhost"});i.location.href=e};var d=function(){var e={uuid:l.get("authesewa").split(":")[1],esewa_id:o.product.username};s.removeUserSession(e)};n.cancelUserDetails=function(){n.loadingBar=!0,o.flag=!0;var e=o.product.fu;d(),delete o.product,l.remove("failureUrl"),l.remove("authesewa",{path:"/",domain:"localhost"}),l.remove("requestStr",{path:"/",domain:"localhost"}),l.remove("JSESSIONID",{path:"/",domain:"localhost"}),l.authesewa=void 0,l.requestStr=void 0,delete l.authesewa,delete l.requestStr,i.location.href=e},n.cancelConfirmation=function(){u.go("userDetails")},n.csrfToken=l.get("XSRF-TOKEN")}]).filter("amount",["$filter",function(t){return function(e){return e%1!=0?t("number")(_.round(e,2),2):t("number")(e,2)}}]),angular.module("epayApp").service("PaymentService",["$http",function(t){this.makePayment=function(e){return t.post("/epay/payment",e)}}]),angular.module("epayApp").service("ProductDetailsService",["$http",function(t){this.getProductName=function(e){return t.get(e)}}]),angular.module("epayApp").factory("LogoutService",["Restangular","$q",function(t,e){return{removeUserSession:function(e){return t.all("api/web/logout").customPOST("","","",e)}}}]),angular.module("epayApp").controller("ErrorMessageController",["$scope","$cookies","$rootScope","$window","LogoutService","$localStorage",function(n,o,r,a,t,i){var e;n.showloadingBar=!1,angular.isDefined(o.get("errormsg",{path:"/epay"}))&&("[object Object]"!==(e=o.get("errormsg",{path:"/epay"}))&&(n.error=e),o.remove("errormsg",{path:"/epay"})),n.error&&'""'!==n.error||(n.error=null,e=new URLSearchParams(window.location.search).get("error"),o.put("errormsg",{path:"/epay"}),n.error=e),n.showLoading=function(){n.showloadingBar=!0},n.cancelRequest=function(){var e,t;n.showLoadingBar=!0,e=!angular.isDefined(r.product)&&angular.isDefined(i.failureUrl)?i.failureUrl:r.product.fu;try{s()}catch(e){}for(t in o.getAll())o.remove(t),o.remove(t,{path:"/epay"}),o.remove(t,{path:"/",domain:"localhost"});a.location.href=e};var s=function(){var e={uuid:o.get("authesewa").split(":")[1],esewa_id:r.product.username};t.removeUserSession(e)}}]),angular.module("epayApp").controller("EpayQrPaymentController",["$scope","$state","EpayQrService","WebSocketService","$rootScope","$window","$timeout",function(n,o,a,e,i,s,c){n.model={transport:"websocket",messages:[]},i.qrEnable=!1,i.showTickAnimation=!1;var r=e;n.isQrEpayEnable=function(e){var t;angular.isDefined(e.scd)&&(n.pid=function(e,t){for(var n="",o="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",r=23;0<r;--r)n+=o[Math.floor(Math.random()*o.length)];return t.substring(0,5)+"-"+e.substring(e.length-5,e.length)+"-"+n.substring(0,10)}(e.pid,e.scd),t={amount:e.tAmt,prn:n.pid,remarks1:e.scd,remarks2:e.scd},a.isQrEnable(e.scd).then(function(e){e&&(t.merchantCode=e,e=t,a.getEpayQrCode(e).then(function(e){e.qrMessage&&(e=e,i.qrEnable=!0,l.text=e.qrMessage,$("#qrCode").qrcode(l),function(e){e={url:e,contentType:"application/json",logLevel:"error",transport:"websocket",trackMessageLength:!0,reconnectInterval:1e4,enableXDR:!0,timeout:4e5,onMessage:function(e){var t=JSON.parse(e.responseBody),r=JSON.parse(t.transactionStatus),e={};angular.isDefined(r.qrVerified)&&r.qrVerified?(e={txnProcessing:!0,pid:i.product.pid,scd:i.product.scd},a.updateEpayTxnStatus(e),i.showTickAnimation=!0,c(function(){o.go("epayqrConfirm")},4e3)):angular.isDefined(r.paymentSuccess)&&(e={txnProcessing:!1,merchantId:t.merchantId,deviceId:t.deviceId,errorMessage:r.paymentSuccess?null:r.message,paymentSuccess:r.paymentSuccess,pid:i.product.pid,scd:i.product.scd,traceId:r.traceId},a.updateEpayTxnStatus(e).then(function(){var t,n,o;r.paymentSuccess?(t=i.product.su,n=r.traceId,o="",a.encodeProductId(i.product.pid).then(function(e){e&&(o=t+(t.includes("?")?"&":"?")+"oid="+e+"&amt="+i.product.tAmt+"&refId="+n,s.location.href=o)})):window.location.href=i.product.fu}))},onError:function(e){o.reload()}};r.subscribe(e,{transports:["long-polling"]})}(e.thirdpartyQrWebSocketUrl))}))}))};var l={render:"canvas",minVersion:1,maxVersion:40,ecLevel:"L",left:0,top:0,size:200,fill:"#000",background:null,text:"",radius:0,quiet:0,mode:0,mSize:.1,mPosX:.5,mPosY:.5,label:"no label",fontname:"sans",fontcolor:"#000",image:null};n.cancelEpayQr=function(){confirm("Do you want to cancel Payment")&&o.go("epayqrCancel")}}]),angular.module("epayApp").service("EpayQrService",["Restangular",function(e){var t=e.all("epay/products");this.isQrEnable=function(e){return t.one(e+"").one("qr_allow_status").customGET()},this.getEpayQrCode=function(e){return t.one("product").one("qr").customPOST(e)},this.getEpayTxnStatus=function(e){return t.one("txn").one("status").customPOST(e)},this.updateEpayTxnStatus=function(e){return t.one("txn").one("status/update").customPOST(e)},this.encodeProductId=function(e){return t.one("url").one(e+"").one("encode").customGET()}}]),angular.module("epayApp").service("WebSocketService",["$rootScope",function(r){var a=["onOpen","onClientTimeout","onReopen","onMessage","onClose","onError"],i=a;return i.push("onTransportFailure"),i.push("onReconnect"),{subscribe:function(n){var o={};return angular.forEach(n,function(e,t){"function"==typeof e&&0<=i.indexOf(t)?0<=a.indexOf(t)?o[t]=function(e){r.$apply(function(){n[t](e)})}:"onTransportFailure"===t?o.onTransportFailure=function(e,t){r.$apply(function(){n.onTransportFailure(e,t)})}:"onReconnect"===t&&(o.onReconnect=function(e,t){r.$apply(function(){n.onReconnect(e,t)})}):o[t]=n[t]}),atmosphere.subscribe(o)}}}]),function(e,t){"function"==typeof define&&define.amd?define(t):"undefined"!=typeof exports?module.exports=t():e.atmosphere=t()}(this,function(){var e,ee={},te=!1,r=[],ne=[],oe=0,l=Object.prototype.hasOwnProperty;return(ee={version:"2.3.2-javascript",onError:function(e){},onClose:function(e){},onOpen:function(e){},onReopen:function(e){},onMessage:function(e){},onReconnect:function(e,t){},onMessagePublished:function(e){},onTransportFailure:function(e,t){},onLocalMessage:function(e){},onFailureToReconnect:function(e,t){},onClientTimeout:function(e){},onOpenAfterResume:function(e){},WebsocketApiAdapter:function(e){var t,n;return e.onMessage=function(e){n.onmessage({data:e.responseBody})},e.onMessagePublished=function(e){n.onmessage({data:e.responseBody})},e.onOpen=function(e){n.onopen(e)},n={close:function(){t.close()},send:function(e){t.push(e)},onmessage:function(e){},onopen:function(e){},onclose:function(e){},onerror:function(e){}},t=new ee.subscribe(e),n},AtmosphereRequest:function(e){function t(){z=!(W=!0),Q=0,J=H=F=X=null}function c(e){return"debug"==e?"debug"===$.logLevel:"info"==e?"info"===$.logLevel||"debug"===$.logLevel:"warn"==e?"warn"===$.logLevel||"info"===$.logLevel||"debug"===$.logLevel:"error"==e&&("error"===$.logLevel||"warn"===$.logLevel||"info"===$.logLevel||"debug"===$.logLevel)}function l(e){c("debug")&&ee.util.debug(new Date+" Atmosphere: "+e)}function u(e,t){return""===j.partialMessage&&"streaming"===t.transport&&e.responseText.length>t.maxStreamingLength}function n(){var n,e,t;!$.enableProtocol||$.disableDisconnect||$.firstMessage||(n="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+$.uuid,ee.util.each($.headers,function(e,t){t=ee.util.isFunction(t)?t.call(this,$,$,j):t;null!=t&&(n+="&"+encodeURIComponent(e)+"="+encodeURIComponent(t))}),e=(e=$.url.replace(/([?&])_=[^&]*/,n))+(e===$.url?(/\?/.test($.url)?"&":"?")+n:""),(t=new ee.AtmosphereRequest({connected:!1})).connectTimeout=$.connectTimeout,t.attachHeadersAsQueryString=!1,t.dropHeaders=!0,t.url=e,t.contentType="text/plain",t.transport="polling",t.method="GET",t.data="",t.heartbeat=null,$.enableXDR&&(t.enableXDR=$.enableXDR),t.async=$.closeAsync,e="",(t=(t=t)||O(e)).transport="polling",t.method="GET",t.withCredentials=!1,t.reconnect=!1,t.force=!0,t.suspend=!1,t.timeout=1e3,a(t))}function d(){l("Closing (AtmosphereRequest._close() called)"),z=!0,$.reconnectId&&(clearTimeout($.reconnectId),delete $.reconnectId),$.heartbeatTimer&&clearTimeout($.heartbeatTimer),$.reconnect=!1,j.request=$,j.state="unsubscribe",j.responseBody="",j.status=408,j.partialMessage="",P(),n(),p()}function p(){j.partialMessage="",$.id&&clearTimeout($.id),$.heartbeatTimer&&clearTimeout($.heartbeatTimer),$.reconnectId&&(clearTimeout($.reconnectId),delete $.reconnectId),null!=J&&(J.close(),J=null),null!=_&&(_.abort(),_=null),null!=H&&(H.abort(),H=null),null!=X&&(X.canSendMessage&&(l("invoking .close() on WebSocket object"),X.close()),X=null),null!=F&&(F.close(),F=null),null!=M&&(clearInterval(B),document.cookie=N+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",M.signal("close",{reason:"",heir:z?(M.get("children")||[])[0]:Z}),M.close()),null!=Y&&Y.close()}function o(e){p(),t(),($=ee.util.extend($,e)).mrequest=$.reconnect,$.reconnect||($.reconnect=!0)}function f(){if($.shared){if(null!=(Y=function(r){function a(e,t){for(var n=e.length,o=0;o<n;o++)e[o]===t&&e.splice(o,1);return n!==e.length}function i(e){var t=(e=ee.util.parseJSON(e)).data;if("c"===e.target)switch(e.type){case"open":g("opening","local",$);break;case"close":s||(s=!0,"aborted"===t.reason?d():t.heir===Z?f():setTimeout(function(){f()},100));break;case"message":E(t,"messageReceived",200,r.transport);break;case"localMessage":A(t)}}function t(){var e=new RegExp("(?:^|; )("+encodeURIComponent(c)+")=([^;]*)").exec(document.cookie);if(e)return ee.util.parseJSON(decodeURIComponent(e[2]))}var n,o,s,c="atmosphere-"+r.url,e=function(){function t(e){e.key===c&&e.newValue&&i(e.newValue)}if(ee.util.storage){function n(e){return ee.util.parseJSON(o.getItem(c+"-"+e))}var o=window.localStorage;return{init:function(){var e=n("children").concat([Z]);return o.setItem(c+"-children",ee.util.stringifyJSON(e)),ee.util.on(window,"storage",t),n("opened")},signal:function(e,t){o.setItem(c,ee.util.stringifyJSON({target:"p",type:e,data:t}))},close:function(){var e=n("children");ee.util.off(window,"storage",t),e&&a(e,r.id)&&o.setItem(c+"-children",ee.util.stringifyJSON(e))}}}},l=function(){var n=window.open("",c.replace(/\W/g,""));if(n&&!n.closed&&n.callbacks)return{init:function(){return n.callbacks.push(i),n.children.push(Z),n.opened},signal:function(e,t){!n.closed&&n.fire&&n.fire(ee.util.stringifyJSON({target:"p",type:e,data:t}))},close:function(){s||(a(n.callbacks,i),a(n.children,Z))}}};if((n=t())&&!(1e3<ee.util.now()-n.ts)&&(o=e()||l()))return{open:function(){var e;return B=setInterval(function(){var e=n;(n=t())&&e.ts!==n.ts||i(ee.util.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:e.heir}}))},1e3),(e=o.init())&&setTimeout(function(){g("opening","local",r)},50),e},send:function(e){o.signal("send",e)},localSend:function(e){o.signal("localSend",ee.util.stringifyJSON({id:Z,event:e}))},close:function(){z||(clearInterval(B),o.signal("close"),o.close())}}}($))&&(c("debug")&&ee.util.debug("Storage service available. All communication will be local"),Y.open($)))return;c("debug")&&ee.util.debug("No Storage service available."),Y=null}var e;$.firstMessage=0==oe,$.isOpen=!1,$.ctime=ee.util.now(),0===$.uuid&&($.uuid=oe),j.closedByClientTimeout=!1,"websocket"!==$.transport&&"sse"!==$.transport?a($):"websocket"===$.transport?null!=$.webSocketImpl||window.WebSocket||window.MozWebSocket?function n(o){j.transport="websocket";var e=y($,ee.util.getAbsoluteURL($.webSocketUrl||$.url)).replace(/^http/,"ws");c("debug")&&ee.util.debug("Invoking executeWebSocket, using URL: "+e);o&&!$.reconnect?null!=X&&p():(e=e,X=null!=$.webSocketImpl?$.webSocketImpl:new(window.WebSocket?WebSocket:MozWebSocket)(e),null!=$.webSocketBinaryType&&(X.binaryType=$.webSocketBinaryType),0<$.connectTimeout&&($.id=setTimeout(function(){if(!o){X.onclose({code:1002,reason:"",wasClean:!1});try{p()}catch(e){}}},$.connectTimeout)),X.onopen=function(e){l("websocket.onopen"),h($),te=!1,c("debug")&&ee.util.debug("Websocket successfully opened"),e=o,null!=X&&(X.canSendMessage=!0),$.enableProtocol||(o=!0,g(e?"re-opening":"opening","websocket",$)),null!=X&&"POST"===$.method&&(j.state="messageReceived",X.send($.data))},X.onmessage=function(e){l("websocket.onmessage"),h($),$.enableProtocol&&(o=!0),j.state="messageReceived",j.status=200,"string"==typeof(e=e.data)?v(e,$,j)||(P(),j.responseBody="",j.messages=[]):""!==(e=s($,e))&&(j.responseBody=e,P(),j.responseBody=null)},X.onerror=function(e){l("websocket.onerror"),clearTimeout($.id),$.heartbeatTimer&&clearTimeout($.heartbeatTimer)},X.onclose=function(e){if(l("websocket.onclose"),clearTimeout($.id),"closed"!==j.state){var t=e.reason;if(""===t)switch(e.code){case 1e3:t="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:t="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:t="The endpoint is terminating the connection due to a protocol error.";break;case 1003:t="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:t="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:t="Unknown: no status code was provided even though one was expected.";break;case 1006:t="Connection was closed abnormally (that is, with no close frame being sent)."}c("warn")&&ee.util.warn("Websocket closed, reason: "+t+" - wasClean: "+e.wasClean),j.closedByClientTimeout||$.handleOnlineOffline&&te?$.reconnectId&&(clearTimeout($.reconnectId),delete $.reconnectId):(U(o),j.state="closed",z?ee.util.log($.logLevel,["Websocket closed normally"]):o?$.reconnect&&"websocket"===j.transport&&(p(),Q++<$.maxReconnectOnClose?(g("re-connecting",$.transport,$),0<$.reconnectInterval?$.reconnectId=setTimeout(function(){j.responseBody="",j.messages=[],n(!0)},$.reconnectInterval):(j.responseBody="",j.messages=[],n(!0))):(ee.util.log($.logLevel,["Websocket reconnect maximum try reached "+Q]),c("warn")&&ee.util.warn("Websocket error, reason: "+e.reason),b(0,"maxReconnectOnClose reached"))):r("Websocket failed on first connection attempt. Downgrading to "+$.fallbackTransport+" and resending"))}},-1<navigator.userAgent.toLowerCase().indexOf("android")&&void 0===X.url&&X.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1}))}(!1):r("Websocket is not supported, using request.fallbackTransport ("+$.fallbackTransport+")"):"sse"===$.transport&&(e=ee.util.getAbsoluteURL($.url.toLowerCase()),e=!(!(e=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(e))||e[1]==window.location.protocol&&e[2]==window.location.hostname&&(e[3]||("http:"===e[1]?80:443))==(window.location.port||("http:"===window.location.protocol?80:443))),!window.EventSource||e&&ee.util.browser.safari&&!(7<=ee.util.browser.vmajor)?r("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+$.fallbackTransport+")"):function t(n){j.transport="sse";var e=y($);c("debug")&&(ee.util.debug("Invoking executeSSE"),ee.util.debug("Using URL: "+e));if(n&&!$.reconnect)null!=F&&p();else{try{F=new EventSource(e,{withCredentials:$.withCredentials})}catch(e){return b(0,e),void r("SSE failed. Downgrading to fallback transport and resending")}0<$.connectTimeout&&($.id=setTimeout(function(){n||p()},$.connectTimeout)),F.onopen=function(e){l("sse.onopen"),h($),c("debug")&&ee.util.debug("SSE successfully opened"),$.enableProtocol?$.isReopen&&($.isReopen=!1,g("re-opening",$.transport,$)):g(n?"re-opening":"opening","sse",$),n=!0,"POST"===$.method&&(j.state="messageReceived",F.send($.data))},F.onmessage=function(e){l("sse.onmessage"),h($),!$.enableXDR&&window.location.host&&e.origin&&e.origin!==window.location.protocol+"//"+window.location.host?ee.util.log($.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]):(j.state="messageReceived",j.status=200,v(e=e.data,$,j)||(P(),j.responseBody="",j.messages=[]))},F.onerror=function(e){l("sse.onerror"),clearTimeout($.id),$.heartbeatTimer&&clearTimeout($.heartbeatTimer),j.closedByClientTimeout||(U(n),p(),z?ee.util.log($.logLevel,["SSE closed normally"]):n?$.reconnect&&"sse"===j.transport&&(Q++<$.maxReconnectOnClose?(g("re-connecting",$.transport,$),0<$.reconnectInterval?$.reconnectId=setTimeout(function(){t(!0)},$.reconnectInterval):t(!0),j.responseBody="",j.messages=[]):(ee.util.log($.logLevel,["SSE reconnect maximum try reached "+Q]),b(0,"maxReconnectOnClose reached"))):r("SSE failed. Downgrading to fallback transport and resending"))}}}(!1))}function g(e,t,n){function o(e){var t=(e=ee.util.parseJSON(e)).data;if("p"===e.target)switch(e.type){case"send":C(t);break;case"localSend":A(t);break;case"close":d()}}function r(){document.cookie=N+"="+encodeURIComponent(ee.util.stringifyJSON({ts:ee.util.now()+1,heir:(a.get("children")||[])[0]}))+"; path=/"}var a,i,s;$.shared&&"local"!==t&&(i="atmosphere-"+$.url,s=function(){var n,e=i.replace(/\W/g,""),t=document.getElementById(e);return t||((t=document.createElement("div")).id=e,t.style.display="none",t.innerHTML='<iframe name="'+e+'" />',document.body.appendChild(t)),n=t.firstChild.contentWindow,{init:function(){n.callbacks=[o],n.fire=function(e){for(var t=0;t<n.callbacks.length;t++)n.callbacks[t](e)}},signal:function(e,t){!n.closed&&n.fire&&n.fire(ee.util.stringifyJSON({target:"c",type:e,data:t}))},get:function(e){return n.closed?null:n[e]},set:function(e,t){n.closed||(n[e]=t)},close:function(){}}},K=function(e){a.signal("message",e)},(a=function(){function e(e){e.key===i&&e.newValue&&o(e.newValue)}if(ee.util.storage){var n=window.localStorage;return{init:function(){ee.util.on(window,"storage",e)},signal:function(e,t){n.setItem(i,ee.util.stringifyJSON({target:"c",type:e,data:t}))},get:function(e){return ee.util.parseJSON(n.getItem(i+"-"+e))},set:function(e,t){n.setItem(i+"-"+e,ee.util.stringifyJSON(t))},close:function(){ee.util.off(window,"storage",e),n.removeItem(i),n.removeItem(i+"-opened"),n.removeItem(i+"-children")}}}}()||s()).init(),c("debug")&&ee.util.debug("Installed StorageService "+a),a.set("children",[]),null==a.get("opened")||a.get("opened")||a.set("opened",!1),N=encodeURIComponent(i),r(),B=setInterval(r,1e3),M=a),null!=M&&M.set("opened",!0),n.close=function(){d()},0<Q&&"re-connecting"===e?(n.isReopen=!0,(s=j).state="re-connecting",L(s)):null==j.error&&(j.request=n,n=j.state,j.state=e,e=j.transport,j.transport=t,t=j.responseBody,P(),j.responseBody=t,j.state=n,j.transport=e)}function m(o){o.transport="jsonp";var r,a=null!=o&&void 0!==o?o:$;(_={open:function(){function e(){var e=a.url;null!=a.dispatchUrl&&(e+=a.dispatchUrl);var t=a.data;a.attachHeadersAsQueryString&&(e=y(a),""!==t&&(e+="&X-Atmosphere-Post-Body="+encodeURIComponent(t)),t=""),t=document.head||document.getElementsByTagName("head")[0]||document.documentElement,(r=document.createElement("script")).src=e+"&jsonpTransport="+n,r.clean=function(){r.clean=r.onerror=r.onload=r.onreadystatechange=null,r.parentNode&&r.parentNode.removeChild(r),2==++o.scriptCount&&(o.scriptCount=1,a.lastIndex=0,a.openId&&clearTimeout(a.openId),a.heartbeatTimer&&clearTimeout(a.heartbeatTimer),a.reconnect&&Q++<a.maxReconnectOnClose?(g("re-connecting",a.transport,a),T(_,a,o.reconnectInterval),a.openId=setTimeout(function(){w(a)},a.reconnectInterval+1e3)):b(0,"maxReconnectOnClose reached"))},r.onload=r.onreadystatechange=function(){l("jsonp.onload"),r.readyState&&!/loaded|complete/.test(r.readyState)||r.clean()},r.onerror=function(){l("jsonp.onerror"),o.scriptCount=1,r.clean()},t.insertBefore(r,t.firstChild)}var n="atmosphere"+ ++Z;window[n]=function(e){if(l("jsonp.window"),o.scriptCount=0,a.reconnect&&-1===a.maxRequest||a.requestCount++<a.maxRequest){if(a.executeCallbackBeforeReconnect||T(_,a,a.pollingInterval),null!=e&&"string"!=typeof e)try{e=e.message}catch(e){}v(e,a,j)||E(j.responseBody,"messageReceived",200,a.transport),a.executeCallbackBeforeReconnect&&T(_,a,a.pollingInterval),h(a)}else ee.util.log($.logLevel,["JSONP reconnect maximum try reached "+$.requestCount]),b(0,"maxRequest reached")},setTimeout(function(){e()},50)},abort:function(){r&&r.clean&&r.clean()}}).open()}function s(e,t){var n=t;if("polling"===e.transport)return n;if(e.enableProtocol&&e.firstMessage&&0!==ee.util.trim(t).length){var o=e.trackMessageLength?1:0,r=t.split(e.messageDelimiter);if(r.length<=o+1)return n;if(e.firstMessage=!1,e.uuid=ee.util.trim(r[o]),r.length<=o+2&&ee.util.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]),V=parseInt(ee.util.trim(r[o+1]),10),G=r[o+2],"long-polling"!==e.transport&&w(e),oe=e.uuid,n="",o=e.trackMessageLength?4:3,r.length>o+1)for(;o<r.length;o++)n+=r[o],o+1!==r.length&&(n+=e.messageDelimiter);0!==e.ackInterval&&setTimeout(function(){C("...ACK...")},e.ackInterval)}else e.enableProtocol&&e.firstMessage&&ee.util.browser.msie&&+ee.util.browser.version.split(".")[0]<10?ee.util.log($.logLevel,["Receiving unexpected data from IE"]):w(e);return n}function h(e){clearTimeout(e.id),0<e.timeout&&"polling"!==e.transport&&(e.id=setTimeout(function(){j.closedByClientTimeout=!0,j.state="closedByClient",j.responseBody="",j.status=408,j.messages=[],P(),n(),p()},e.timeout))}function b(e,t){p(),clearTimeout($.id),j.state="error",j.reasonPhrase=t,j.responseBody="",j.status=e,j.messages=[],P()}function v(e,t,n){if(0===(e=s(t,e)).length)return!0;if(n.responseBody=e,t.trackMessageLength){var o=[],r=(e=n.partialMessage+e).indexOf(t.messageDelimiter);if(-1!=r){for(;-1!==r;){var a=e.substring(0,r),i=+a;if(isNaN(i))throw Error('message length "'+a+'" is not a number');r=(r+=t.messageDelimiter.length)+i>e.length?-1:(o.push(e.substring(r,r+i)),(e=e.substring(r+i,e.length)).indexOf(t.messageDelimiter))}return(n.partialMessage=e,0!==o.length)?(n.responseBody=o.join(t.messageDelimiter),n.messages=o,!1):(n.responseBody="",n.messages=[],!0)}}return n.responseBody=e,!(n.messages=[e])}function r(e){ee.util.log($.logLevel,[e]),void 0!==$.onTransportFailure?$.onTransportFailure(e,$):void 0!==ee.util.onTransportFailure&&ee.util.onTransportFailure(e,$),$.transport=$.fallbackTransport,e=-1===$.connectTimeout?0:$.connectTimeout,$.reconnect&&"none"!==$.transport||null==$.transport?($.method=$.fallbackMethod,j.transport=$.fallbackTransport,$.fallbackTransport="none",0<e?$.reconnectId=setTimeout(function(){f()},e):f()):b(500,"Unable to reconnect with fallback transport")}function y(n,o){var r=null!=n&&void 0!==n?n:$;return null==o&&(o=r.url),r.attachHeadersAsQueryString&&-1===o.indexOf("X-Atmosphere-Framework")&&(o+=-1!==o.indexOf("?")?"&":"?",o+="X-Atmosphere-tracking-id="+r.uuid,o+="&X-Atmosphere-Framework="+ee.version,o+="&X-Atmosphere-Transport="+r.transport,r.trackMessageLength&&(o+="&X-Atmosphere-TrackMessageSize=true"),null!==r.heartbeat&&null!==r.heartbeat.server&&(o+="&X-Heartbeat-Server="+r.heartbeat.server),""!==r.contentType&&(o+="&Content-Type="+("websocket"===r.transport?r.contentType:encodeURIComponent(r.contentType))),r.enableProtocol&&(o+="&X-atmo-protocol=true"),ee.util.each(r.headers,function(e,t){t=ee.util.isFunction(t)?t.call(this,r,n,j):t;null!=t&&(o+="&"+encodeURIComponent(e)+"="+encodeURIComponent(t))})),o}function w(e){if(e.isOpen)if(e.isReopen)e.isReopen=!1,g("re-opening",e.transport,e);else{if("messageReceived"!==j.state||"jsonp"!==e.transport&&"long-polling"!==e.transport)return;var t=j;t.state="openAfterResume",L(t),t.state="messageReceived"}else e.isOpen=!0,g("opening",e.transport,e);!function(e){{var t;null!=e.heartbeatTimer&&clearTimeout(e.heartbeatTimer),!isNaN(V)&&0<V&&(t=function(){c("debug")&&ee.util.debug("Sending heartbeat"),C(G),e.heartbeatTimer=setTimeout(t,V)},e.heartbeatTimer=setTimeout(t,V))}}(e)}function a(o){var n,r,a,e,i=null==o&&void 0===o?$:o;if(i.lastIndex=0,i.readyState=0,"jsonp"===i.transport||i.enableXDR&&ee.util.checkCORSSupport())m(i);else{if(ee.util.browser.msie&&+ee.util.browser.version.split(".")[0]<10){if("streaming"===i.transport)return void(i.enableXDR&&window.XDomainRequest?k:R)(i);if(i.enableXDR&&window.XDomainRequest)return void k(i)}function t(e){i.lastIndex=0,Q++,e||i.reconnect&&Q<=i.maxReconnectOnClose?(e=e?0:o.reconnectInterval,j.ffTryingReconnect=!0,g("re-connecting",o.transport,o),T(c,i,e)):b(0,"maxReconnectOnClose reached")}function s(e){ee._beforeUnloadState?(ee.util.debug(new Date+" Atmosphere: reconnectF: execution delayed due to _beforeUnloadState flag"),setTimeout(function(){t(e)},5e3)):t(e)}if(i.force||i.reconnect&&(-1===i.maxRequest||i.requestCount++<i.maxRequest)){i.force=!1;var c=ee.util.xhr();c.hasData=!1,n=c,a=!0,e=(r=i).url,null!=r.dispatchUrl&&"POST"===r.method&&(e+=r.dispatchUrl),e=y(r,e),e=ee.util.prepareURL(e),a&&(n.open(r.method,e,r.async),0<r.connectTimeout&&(r.id=setTimeout(function(){0===r.requestCount&&(p(),E("Connect timeout","closed",200,r.transport))},r.connectTimeout))),$.withCredentials&&"websocket"!==$.transport&&"withCredentials"in n&&(n.withCredentials=!0),$.dropHeaders||(n.setRequestHeader("X-Atmosphere-Framework",ee.version),n.setRequestHeader("X-Atmosphere-Transport",r.transport),null!==r.heartbeat&&null!==r.heartbeat.server&&n.setRequestHeader("X-Heartbeat-Server",n.heartbeat.server),r.trackMessageLength&&n.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),n.setRequestHeader("X-Atmosphere-tracking-id",r.uuid),ee.util.each(r.headers,function(e,t){t=ee.util.isFunction(t)?t.call(this,n,r,a,j):t;null!=t&&n.setRequestHeader(e,t)})),""!==r.contentType&&n.setRequestHeader("Content-Type",r.contentType),i.suspend&&(H=c),"polling"!==i.transport&&(j.transport=i.transport,c.onabort=function(){l("ajaxrequest.onabort"),U(!0)},c.onerror=function(){l("ajaxrequest.onerror"),j.error=!0,j.ffTryingReconnect=!0;try{j.status=XMLHttpRequest.status}catch(e){j.status=500}j.status||(j.status=500),j.errorHandled||(p(),s(!1))}),c.onreadystatechange=function(){if(l("ajaxRequest.onreadystatechange, new state: "+c.readyState),z)l("onreadystatechange has been ignored due to _abortingConnection flag");else{j.error=null;var t=!1,e=!1;if("streaming"===i.transport&&2<i.readyState&&4===c.readyState)p(),s(!1);else{if(i.readyState=c.readyState,("streaming"===i.transport&&3<=c.readyState||"long-polling"===i.transport&&4===c.readyState)&&(e=!0),h($),"polling"!==i.transport){var n=200;if(4===c.readyState&&(n=1e3<c.status?0:c.status),!i.reconnectOnServerError&&300<=n&&n<600)return void b(n,c.statusText);if(300<=n||0===n)return j.errorHandled=!0,p(),void s(!1);i.enableProtocol&&o.firstMessage||2!==c.readyState||(ee.util.browser.mozilla&&j.ffTryingReconnect?(j.ffTryingReconnect=!1,setTimeout(function(){j.ffTryingReconnect||w(i)},500)):w(i))}else 4===c.readyState&&(e=!0);if(e)if(e=c.responseText,j.errorHandled=!1,"long-polling"===i.transport&&0===ee.util.trim(e).length)c.hasData?c.hasData=!1:s(!0);else{if(c.hasData=!0,q(c,$),"streaming"===i.transport){if(ee.util.browser.opera)ee.util.iterate(function(){if(500!==j.status&&c.responseText.length>i.lastIndex){try{j.status=c.status,j.headers=ee.util.parseHeaders(c.getAllResponseHeaders()),q(c,$)}catch(e){j.status=404}h($),j.state="messageReceived";var e=c.responseText.substring(i.lastIndex);i.lastIndex=c.responseText.length,(t=v(e,i,j))||P(),u(c,i)&&S(c,i)}else if(400<j.status)return i.lastIndex=c.responseText.length,!1},0);else if(n=e.substring(i.lastIndex,e.length),t=v(n,i,j),i.lastIndex=e.length,t)return}else t=v(e,i,j);e=u(c,i);try{j.status=c.status,j.headers=ee.util.parseHeaders(c.getAllResponseHeaders()),q(c,i)}catch(e){j.status=404}j.state=i.suspend?0===j.status?"closed":"messageReceived":"messagePublished",(n=!e&&"streaming"!==o.transport&&"polling"!==o.transport)&&!i.executeCallbackBeforeReconnect&&T(c,i,i.pollingInterval),0===j.responseBody.length||t||P(),n&&i.executeCallbackBeforeReconnect&&T(c,i,i.pollingInterval),e&&S(c,i)}}}};try{c.send(i.data),W=!0}catch(e){ee.util.log(i.logLevel,["Unable to connect to "+i.url]),b(0,e)}}else"debug"===i.logLevel&&ee.util.log(i.logLevel,["Max re-connection reached."]),b(0,"maxRequest reached")}}function S(e,t){j.messages=[],t.isReopen=!0,d(),z=!1,T(e,t,500)}function T(e,t,n){var o;!j.closedByClientTimeout&&(t.reconnect||t.suspend&&W)&&(o=0,e&&1<e.readyState&&(o=1e3<e.status?0:e.status),j.status=0===o?204:o,j.reason=0===o?"Server resumed the connection or down.":"OK",clearTimeout(t.id),t.reconnectId&&(clearTimeout(t.reconnectId),delete t.reconnectId),0<n?$.reconnectId=setTimeout(function(){a(t)},n):a(t))}function k(e){"polling"!==e.transport?(J=i(e)).open():i(e).open()}function i(e){var n=$;null!=e&&void 0!==e&&(n=e);function o(){"long-polling"===n.transport&&n.reconnect&&(-1===n.maxRequest||n.requestCount++<n.maxRequest)&&(i.status=200,k(n))}var r=n.transport,a=0,i=new window.XDomainRequest,t=n.rewriteURL||function(e){var t=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(t&&t[1]){case"JSESSIONID":return e.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+t[2]+"$1");case"PHPSESSID":return e.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+t[2]+"&").replace(/&$/,"")}return e};return i.onprogress=function(){clearTimeout(n.id);var e,t=(t=i.responseText).substring(a);a+=t.length,"polling"!==r&&(h(n),e=v(t,n,j),"long-polling"===r&&0===ee.util.trim(t).length||(n.executeCallbackBeforeReconnect&&o(),e||E(j.responseBody,"messageReceived",200,r),n.executeCallbackBeforeReconnect||o()))},i.onerror=function(){"polling"!==n.transport&&(p(),Q++<n.maxReconnectOnClose?0<n.reconnectInterval?n.reconnectId=setTimeout(function(){g("re-connecting",e.transport,e),k(n)},n.reconnectInterval):(g("re-connecting",e.transport,e),k(n)):b(0,"maxReconnectOnClose reached"))},i.onload=function(){},{open:function(){var e=n.url;null!=n.dispatchUrl&&(e+=n.dispatchUrl),e=y(n,e),i.open(n.method,t(e)),"GET"===n.method?i.send():i.send(n.data),0<n.connectTimeout&&(n.id=setTimeout(function(){0===n.requestCount&&(p(),E("Connect timeout","closed",200,n.transport))},n.connectTimeout))},close:function(){i.abort()}}}function R(e){(J=function(e){var r=$;null!=e&&void 0!==e&&(r=e);var a,i=new window.ActiveXObject("htmlfile");i.open(),i.close();var t=r.url;return null!=r.dispatchUrl&&(t+=r.dispatchUrl),"polling"!==r.transport&&(j.transport=r.transport),{open:function(){var e=i.createElement("iframe");t=y(r),""!==r.data&&(t+="&X-Atmosphere-Post-Body="+encodeURIComponent(r.data)),t=ee.util.prepareURL(t),e.src=t,i.body.appendChild(e);var o=e.contentDocument||e.contentWindow.document;a=ee.util.iterate(function(){try{if(o.firstChild){var e,t,n=o.body?o.body.lastChild:o;return o.body&&o.body.firstChild&&"pre"===o.body.firstChild.nodeName.toLowerCase()||(e=o.head||o.getElementsByTagName("head")[0]||o.documentElement||o,(t=o.createElement("script")).text="document.write('<plaintext>')",e.insertBefore(t,e.firstChild),e.removeChild(t),n=o.body.lastChild),r.closed&&(r.isReopen=!0),a=ee.util.iterate(function(){var e,e=((e=n.cloneNode(!0)).appendChild(o.createTextNode(".")),(e=e.innerText).substring(0,e.length-1));if(e.length>r.lastIndex){if(h($),j.status=200,j.error=null,n.innerText="",v(e,r,j))return"";E(j.responseBody,"messageReceived",200,r.transport)}if(r.lastIndex=0,"complete"===o.readyState)return U(!0),g("re-connecting",r.transport,r),0<r.reconnectInterval?r.reconnectId=setTimeout(function(){R(r)},r.reconnectInterval):R(r),!1},null),!1}}catch(e){return j.error=!0,g("re-connecting",r.transport,r),Q++<r.maxReconnectOnClose?0<r.reconnectInterval?r.reconnectId=setTimeout(function(){R(r)},r.reconnectInterval):R(r):b(0,"maxReconnectOnClose reached"),i.execCommand("Stop"),i.close(),!1}})},close:function(){a&&a(),i.execCommand("Stop"),U(!0)}}}(e)).open()}function C(e){null!=Y?Y.send(e):null!=H||null!=F?I(e):null!=J?$.enableXDR&&ee.util.checkCORSSupport()?((e=O(e)).reconnect=!1,m(e)):I(e):null!=_?I(e):null!=X?function(t){var e,n=ee.util.isBinary(t)?t:x(t);try{e=null!=$.dispatchUrl?$.webSocketPathDelimiter+$.dispatchUrl+$.webSocketPathDelimiter+n:n,X.canSendMessage?X.send(e):ee.util.error("WebSocket not connected.")}catch(e){X.onclose=function(e){},p(),r("Websocket failed. Downgrading to "+$.fallbackTransport+" and resending "+t),I(t)}}(e):(b(0,"No suspended connection available"),ee.util.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before trying to push data"))}function I(e){a(e=O(e))}function x(e){var t=e;return"object"==typeof t&&(t=e.data),t}function O(e){var t=x(e),t={connected:!1,timeout:6e4,method:"POST",url:$.url,contentType:$.contentType,headers:$.headers,reconnect:!0,callback:null,data:t,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:$.withCredentials,async:$.async,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:$.enableXDR,uuid:$.uuid,dispatchUrl:$.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:$.trackMessageLength,maxReconnectOnClose:$.maxReconnectOnClose,heartbeatTimer:$.heartbeatTimer,heartbeat:$.heartbeat};return"object"==typeof e&&(t=ee.util.extend(t,e)),t}function A(e){(e=ee.util.parseJSON(e)).id!==Z&&(void 0!==$.onLocalMessage?$.onLocalMessage(e.event):void 0!==ee.util.onLocalMessage&&ee.util.onLocalMessage(e.event))}function E(e,t,n,o){j.responseBody=e,j.transport=o,j.status=n,j.state=t,P()}function q(e,t){if(t.readResponsesHeaders)try{var n=e.getResponseHeader("X-Atmosphere-tracking-id");n&&null!=n&&(t.uuid=n.split(" ").pop())}catch(e){}else t.enableProtocol||(t.uuid=Z)}function L(e){D(e,$),D(e,ee.util)}function D(e,t){switch(e.state){case"messageReceived":l("Firing onMessage"),void(Q=0)!==t.onMessage&&t.onMessage(e),void 0!==t.onmessage&&t.onmessage(e);break;case"error":l("Firing onError, reasonPhrase: "+(void 0!==e.reasonPhrase?e.reasonPhrase:"n/a")),void 0!==t.onError&&t.onError(e),void 0!==t.onerror&&t.onerror(e);break;case"opening":delete $.closed,l("Firing onOpen"),void 0!==t.onOpen&&t.onOpen(e),void 0!==t.onopen&&t.onopen(e);break;case"messagePublished":l("Firing messagePublished"),void 0!==t.onMessagePublished&&t.onMessagePublished(e);break;case"re-connecting":l("Firing onReconnect"),void 0!==t.onReconnect&&t.onReconnect($,e);break;case"closedByClient":l("Firing closedByClient"),void 0!==t.onClientTimeout&&t.onClientTimeout($);break;case"re-opening":delete $.closed,l("Firing onReopen"),void 0!==t.onReopen&&t.onReopen($,e);break;case"fail-to-reconnect":l("Firing onFailureToReconnect"),void 0!==t.onFailureToReconnect&&t.onFailureToReconnect($,e);break;case"unsubscribe":case"closed":void 0!==$.closed&&$.closed?l("Request already closed, not firing onClose ("+e.state+" case)"):(l("Firing onClose ("+e.state+" case)"),void 0!==t.onClose&&t.onClose(e),void 0!==t.onclose&&t.onclose(e)),$.closed=!0;break;case"openAfterResume":void 0!==t.onOpenAfterResume&&t.onOpenAfterResume($)}}function U(e){"closed"!==j.state&&(j.state="closed",j.responseBody="",j.messages=[],j.status=e?200:501,P())}function P(){function e(e,t){t(j)}null==Y&&null!=K&&K(j.responseBody),$.reconnect=$.mrequest;for(var t="string"==typeof j.responseBody,n=t&&$.trackMessageLength?0<j.messages.length?j.messages:[""]:Array(j.responseBody),o=0;o<n.length;o++)if(!(1<n.length&&0===n[o].length||(j.responseBody=t?ee.util.trim(n[o]):n[o],null==Y&&null!=K&&K(j.responseBody),(0===j.responseBody.length||t&&G===j.responseBody)&&"messageReceived"===j.state))){if(L(j),0<ne.length){c("debug")&&ee.util.debug("Invoking "+ne.length+" global callbacks: "+j.state);try{ee.util.each(ne,e)}catch(e){ee.util.log($.logLevel,["Callback exception"+e])}}if("function"==typeof $.callback){c("debug")&&ee.util.debug("Invoking request callbacks");try{$.callback(j)}catch(e){ee.util.log($.logLevel,["Callback exception"+e])}}}}var M,B,N,$={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,disableDisconnect:!1,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,closeAsync:!1,reconnectOnServerError:!0,handleOnlineOffline:!0,onError:function(e){},onClose:function(e){},onOpen:function(e){},onMessage:function(e){},onReopen:function(e,t){},onReconnect:function(e,t){},onMessagePublished:function(e){},onTransportFailure:function(e,t){},onLocalMessage:function(e){},onFailureToReconnect:function(e,t){},onClientTimeout:function(e){},onOpenAfterResume:function(e){}},j={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},X=null,F=null,H=null,J=null,_=null,W=!0,Q=0,V=0,G="X",z=!1,K=null,Y=null,Z=ee.util.now();o(e),this.subscribe=function(e){o(e),f()},this.execute=function(){f()},this.close=function(){d()},this.disconnect=function(){n()},this.getUrl=function(){return $.url},this.push=function(e,t){var n;null!=t?(n=$.dispatchUrl,$.dispatchUrl=t,C(e),$.dispatchUrl=n):C(e)},this.getUUID=function(){return $.uuid},this.pushLocal=function(e){if(0!==e.length)try{Y?Y.localSend(e):M&&M.signal("localMessage",ee.util.stringifyJSON({id:Z,event:e}))}catch(e){ee.util.error(e)}},this.enableProtocol=function(e){return $.enableProtocol},this.init=function(){t()},this.request=$,this.response=j},subscribe:function(e,t,n){return"function"==typeof t&&ee.addCallback(t),"string"!=typeof e?n=e:n.url=e,oe=void 0!==n&&void 0!==n.uuid?n.uuid:0,(e=new ee.AtmosphereRequest(n)).execute(),r[r.length]=e},unsubscribe:function(){if(0<r.length)for(var e=[].concat(r),t=0;t<e.length;t++){var n=e[t];n.close(),clearTimeout(n.response.request.id),n.heartbeatTimer&&clearTimeout(n.heartbeatTimer)}r=[],ne=[]},unsubscribeUrl:function(e){var t=-1;if(0<r.length)for(var n=0;n<r.length;n++){var o=r[n];if(o.getUrl()===e){o.close(),clearTimeout(o.response.request.id),o.heartbeatTimer&&clearTimeout(o.heartbeatTimer),t=n;break}}0<=t&&r.splice(t,1)},addCallback:function(e){-1===ee.util.inArray(e,ne)&&ne.push(e)},removeCallback:function(e){-1!==(e=ee.util.inArray(e,ne))&&ne.splice(e,1)},util:{browser:{},parseHeaders:function(e){for(var t,n=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,o={};t=n.exec(e);)o[t[1]]=t[2];return o},now:function(){return(new Date).getTime()},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},inArray:function(e,t){if(Array.prototype.indexOf)return t.indexOf(e);for(var n=t.length,o=0;o<n;++o)if(t[o]===e)return o;return-1},isBinary:function(e){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(e))},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)},getAbsoluteURL:function(e){if(void 0===document.createElement)return e;var t=document.createElement("div");return t.innerHTML='<a href="'+e+'"/>',encodeURI(decodeURI(t.firstChild.href))},prepareURL:function(e){var t=ee.util.now(),n=e.replace(/([?&])_=[^&]*/,"$1_="+t);return n+(n===e?(/\?/.test(e)?"&":"?")+"_="+t:"")},trim:function(e){return String.prototype.trim?e.toString().trim():e.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(e){function r(e,t){t=ee.util.isFunction(t)?t():null==t?"":t,n.push(encodeURIComponent(e)+"="+encodeURIComponent(t))}var t,n=[];for(t in e)!function n(o,e){if(ee.util.isArray(e))ee.util.each(e,function(e,t){/\[\]$/.test(o)?r(o,t):n(o+"["+("object"==typeof t?e:"")+"]",t)});else if("[object Object]"===Object.prototype.toString.call(e))for(var t in e)n(o+"["+t+"]",e[t]);else r(o,e)}(t,e[t]);return n.join("&").replace(/%20/g,"+")},storage:function(){try{return!(!window.localStorage||!window.StorageEvent)}catch(e){return!1}},iterate:function(t,n){var o;return n=n||0,function e(){o=setTimeout(function(){!1!==t()&&e()},n)}(),function(){clearTimeout(o)}},each:function(e,t,n){if(e){var o=0,r=e.length,a=ee.util.isArray(e);if(n){if(a)for(;o<r&&!1!==(a=t.apply(e[o],n));o++);else for(o in e)if(!1===(a=t.apply(e[o],n)))break}else if(a)for(;o<r&&!1!==(a=t.call(e[o],o,e[o]));o++);else for(o in e)if(a=t.call(e[o],o,e[o]),!1===a)break;return e}},extend:function(e){for(var t,n,o=1;o<arguments.length;o++)if(null!=(t=arguments[o]))for(n in t)e[n]=t[n];return e},on:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)},off:function(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)},log:function(e,t){!window.console||"function"==typeof(e=window.console[e])&&e.apply(window.console,t)},warn:function(){ee.util.log("warn",arguments)},info:function(){ee.util.log("info",arguments)},debug:function(){ee.util.log("debug",arguments)},error:function(){ee.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(e){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}},parseJSON:function(e){return e?window.JSON&&window.JSON.parse?window.JSON.parse(e):new Function("return "+e)():null},stringifyJSON:function(e){function s(e){return'"'+e.replace(t,function(e){var t=n[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"'}function c(e){return e<10?"0"+e:e}var t=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,n={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return window.JSON&&window.JSON.stringify?window.JSON.stringify(e):function e(t,n){var o,r,a=n[t],i=typeof a;switch(a&&"object"==typeof a&&"function"==typeof a.toJSON&&(i=typeof(a=a.toJSON(t))),i){case"string":return s(a);case"number":return isFinite(a)?String(a):"null";case"boolean":return String(a);case"object":if(!a)return"null";switch(Object.prototype.toString.call(a)){case"[object Date]":return isFinite(a.valueOf())?'"'+a.getUTCFullYear()+"-"+c(a.getUTCMonth()+1)+"-"+c(a.getUTCDate())+"T"+c(a.getUTCHours())+":"+c(a.getUTCMinutes())+":"+c(a.getUTCSeconds())+'Z"':"null";case"[object Array]":for(r=a.length,i=[],o=0;o<r;o++)i.push(e(o,a)||"null");return"["+i.join(",")+"]";default:for(o in i=[],a)l.call(a,o)&&(r=e(o,a))&&i.push(s(o)+":"+r);return"{"+i.join(",")+"}"}}}("",{"":e})},checkCORSSupport:function(){if(ee.util.browser.msie&&!window.XDomainRequest&&+ee.util.browser.version.split(".")[0]<11||ee.util.browser.opera&&+ee.util.browser.version.split(".")<12||"KreaTVWebKit/531"===ee.util.trim(navigator.userAgent).slice(0,16)||"kreatel"===ee.util.trim(navigator.userAgent).slice(-7).toLowerCase())return!0;var e=navigator.userAgent.toLowerCase().match(/.+android ([0-9]{1,2})/i),e=parseInt(e&&e[0]||-1,10);return!isNaN(e)&&-1<e&&e<3}}}).util.now(),e=navigator.userAgent.toLowerCase(),"safari"===(e=/(chrome)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(e)||e.indexOf("android")<0&&/version\/(.+) (safari)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[])[2]&&(e[2]=e[1],e[1]="safari"),ee.util.browser[e[1]||""]=!0,ee.util.browser.version=e[2]||"0",ee.util.browser.vmajor=ee.util.browser.version.split(".")[0],ee.util.browser.trident&&(ee.util.browser.msie=!0),(ee.util.browser.msie||ee.util.browser.mozilla&&1==+ee.util.browser.version.split(".")[0])&&(ee.util.storage=!1),ee.util.on(window,"unload",function(e){ee.util.debug(new Date+" Atmosphere: unload event"),ee.unsubscribe()}),ee.util.on(window,"beforeunload",function(e){ee.util.debug(new Date+" Atmosphere: beforeunload event"),ee._beforeUnloadState=!0,setTimeout(function(){ee.util.debug(new Date+" Atmosphere: beforeunload event timeout reached. Reset _beforeUnloadState flag"),ee._beforeUnloadState=!1},5e3)}),ee.util.on(window,"keypress",function(e){27!==e.charCode&&27!==e.keyCode||!e.preventDefault||e.preventDefault()}),ee.util.on(window,"offline",function(){if(ee.util.debug(new Date+" Atmosphere: offline event"),te=!0,0<r.length)for(var e=[].concat(r),t=0;t<e.length;t++){var n=e[t];n.request.handleOnlineOffline&&(n.close(),clearTimeout(n.response.request.id),n.heartbeatTimer&&clearTimeout(n.heartbeatTimer))}}),ee.util.on(window,"online",function(){if(ee.util.debug(new Date+" Atmosphere: online event"),0<r.length)for(var e=0;e<r.length;e++)r[e].request.handleOnlineOffline&&(r[e].init(),r[e].execute());te=!1}),ee});})();